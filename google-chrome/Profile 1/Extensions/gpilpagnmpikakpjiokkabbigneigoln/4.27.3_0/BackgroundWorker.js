(()=>{"use strict";class t{static get(){return chrome}}var e=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{s(o.next(t))}catch(t){a(t)}}function c(t){try{s(o.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}s((o=o.apply(t,e||[])).next())}))};const n="@FETCH_REQUEST_MESSAGE",o="@BROWSER_ICON_TEXT_MESSAGE",i="@CASHBACK_POPUP_CLOSE_MESSAGE";class a{static send(n,o){return e(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{t.get().runtime.sendMessage({id:n,payload:o},(t=>{e(t)}))}))}))}static sendDOMMessage(t,n){return e(this,void 0,void 0,(function*(){return window.parent.postMessage({id:t,payload:n},"*")}))}}var r=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{s(o.next(t))}catch(t){a(t)}}function c(t){try{s(o.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}s((o=o.apply(t,e||[])).next())}))};const c="@AUTH_KEY",s="@ANONYMOUS_ID_KEY",d="@SESSION_ID_KEY",l="@CASHBACK_KEY",u="@ACT_PINNED_TAB_ID",f="@BADGE_TOGGLE_KEY";class h{static set(e,n){return r(this,void 0,void 0,(function*(){return yield t.get().storage.local.set({[e]:n}),n}))}static get(e){return r(this,void 0,void 0,(function*(){const n=yield t.get().storage.local.get(e);if(n)return n[e]}))}static remove(e){return r(this,void 0,void 0,(function*(){return t.get().storage.local.remove(e)}))}static clear(){return r(this,void 0,void 0,(function*(){return t.get().storage.local.clear()}))}}let v=t=>crypto.getRandomValues(new Uint8Array(t));class y{static logEvent(t,e,n){var o,i,a,r,c;return i=this,a=void 0,c=function*(){try{const i=yield p.generateAnonymousId();yield fetch("https://europe-west2-qoala-analytics.cloudfunctions.net/logEvent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event_name:e,uid:null!==(o=null==t?void 0:t.uid)&&void 0!==o?o:"",anonymous_id:i,platform:"chrome-extension",version:"4.27.3",test:!1,event_properties:n})})}catch(t){console.log(t)}},new((r=void 0)||(r=Promise))((function(t,e){function n(t){try{s(c.next(t))}catch(t){e(t)}}function o(t){try{s(c.throw(t))}catch(t){e(t)}}function s(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(n,o)}s((c=c.apply(i,a||[])).next())}))}}var g=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{s(o.next(t))}catch(t){a(t)}}function c(t){try{s(o.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}s((o=o.apply(t,e||[])).next())}))};class p{static generateAnonymousId(){return g(this,void 0,void 0,(function*(){const t=((t,e=21)=>((t,e,n)=>{let o=(2<<Math.log(t.length-1)/Math.LN2)-1,i=-~(1.6*o*e/t.length);return(a=e)=>{let r="";for(;;){let e=n(i),c=i;for(;c--;)if(r+=t[e[c]&o]||"",r.length===a)return r}}})(t,e,v))("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",21);let e=yield h.get(s);return e||(e=t(),yield h.set(s,e)),e}))}static logEvent(t,e,n){return g(this,void 0,void 0,(function*(){try{yield y.logEvent(t,e,n)}catch(t){console.log(t)}}))}static getSessionId(){return g(this,void 0,void 0,(function*(){let t=yield h.get(d);return t?t+36e5<Date.now()?(t=Date.now(),yield h.set(d,t),t.toString()):t.toString():(t=Date.now(),yield h.set(d,t),t.toString())}))}}class m{static fetch(t,e){return o=this,i=void 0,c=function*(){return a.send(n,{url:t,request:e})},new((r=void 0)||(r=Promise))((function(t,e){function n(t){try{s(c.next(t))}catch(t){e(t)}}function a(t){try{s(c.throw(t))}catch(t){e(t)}}function s(e){var o;e.done?t(e.value):(o=e.value,o instanceof r?o:new r((function(t){t(o)}))).then(n,a)}s((c=c.apply(o,i||[])).next())}));var o,i,r,c}}var E=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{s(o.next(t))}catch(t){a(t)}}function c(t){try{s(o.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}s((o=o.apply(t,e||[])).next())}))};class _{constructor(t,e,n,o,i,a,r){this.uid=t,this.anonymous_id=e,this.email=n,this.name=o,this.createdAt=i,this.photoUrl=a,this.token=r}static get(){return E(this,void 0,void 0,(function*(){return h.get(c)}))}static refreshToken(){var t;return E(this,void 0,void 0,(function*(){const e=yield _.get();return(new URLSearchParams).set("data",JSON.stringify({grant_type:"refresh_token",refresh_token:null==e?void 0:e.token})),(yield m.fetch("https://securetoken.googleapis.com/v1/token?key=AIzaSyDgoYNNtBEjkKS3BwzYvYsuD0-CrdyyXJY",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:null!==(t=null==e?void 0:e.token)&&void 0!==t?t:""}).toString()})).id_token}))}}class w{static send(){return t=this,e=void 0,o=function*(){try{const t=yield _.get();if(!t)return;yield fetch(`https://europe-west2-qoala-648cc.cloudfunctions.net/attributeInstallTransaction?uid=${null==t?void 0:t.uid}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:null==t?void 0:t.uid,platform_id:"chrome-extension"})})}catch(t){console.error(t)}},new((n=void 0)||(n=Promise))((function(i,a){function r(t){try{s(o.next(t))}catch(t){a(t)}}function c(t){try{s(o.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}s((o=o.apply(t,e||[])).next())}));var t,e,n,o}}var S=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{s(o.next(t))}catch(t){a(t)}}function c(t){try{s(o.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}s((o=o.apply(t,e||[])).next())}))};class A{constructor(t,e,n){this.host=t,this.exp=e,this.clickId=n}static set(t,e){return S(this,void 0,void 0,(function*(){return h.set(l,{host:t,exp:Date.now()+18e5,clickId:e})}))}static get(){return S(this,void 0,void 0,(function*(){return h.get(l)}))}static isActive(t){return S(this,void 0,void 0,(function*(){const e=yield h.get(l);return!!e&&e.host===t&&e.exp>Date.now()}))}}const k={default:"#FB8500",_dark:"#FB8500"},x={default:"#00b491",_dark:"#4dcbb2"},b="@BADGE_ALARM_NAME";var T=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{s(o.next(t))}catch(t){a(t)}}function c(t){try{s(o.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}s((o=o.apply(t,e||[])).next())}))};function B(e){return T(this,void 0,void 0,(function*(){if(!e.payload)return;const{reset:n,activeCashback:o}=e.payload,i=t.get().action;return i?n?(i.setBadgeBackgroundColor({color:k.default}),i.setBadgeText({text:""}),void(yield t.get().alarms.clear(b))):void(o?o&&(i.setBadgeBackgroundColor({color:x.default}),i.setBadgeText({text:"â‚¬"}),i.setBadgeTextColor({color:"#FFFFFF"}),yield t.get().alarms.clear(b)):yield t.get().alarms.create(b,{periodInMinutes:.04,when:Date.now()+500})):void 0}))}t.get().runtime.onInstalled.addListener((e=>T(void 0,void 0,void 0,(function*(){"install"===e.reason?function(){T(this,void 0,void 0,(function*(){return console.log("Qoala Installed."),yield p.logEvent(void 0,"Extension Installed Callback",{}),yield t.get().tabs.create({active:!0,url:"https://joinqoala.com/install-webstore"})}))}():"update"===e.reason&&function(){T(this,void 0,void 0,(function*(){console.log("Qoala Updated.")}))}()})))),t.get().runtime.setUninstallURL("https://joinqoala.com/feedback"),t.get().runtime.onMessage.addListener(((e,a,r)=>{switch(e.id){case"qoala.AUTH_MESSAGE_ID":(function(t){return T(this,void 0,void 0,(function*(){const{payload:e}=t;e&&(console.debug("Received auth",e),yield h.set(c,{uid:e.uid,anonymous_id:e.anonymous_id,email:e.email,name:e.name,createdAt:e.createdAt,photoUrl:e.photoUrl,token:e.token}),yield w.send())}))})(e).then().catch().finally((()=>!0));break;case"@EXTENSION_INSTALL_MESSAGE":(function(){return T(this,void 0,void 0,(function*(){yield w.send()}))})().then().catch().finally((()=>!0));break;case"@ANONYMOUS_ID_MESSAGE":(function(t){return T(this,void 0,void 0,(function*(){const{payload:e}=t;e&&(yield h.set(s,e.anonymous_id))}))})(e).then().catch().finally((()=>!0));break;case"@CREATE_TAB_MESSAGE":(function(e){return T(this,void 0,void 0,(function*(){const{payload:n}=e;if(n)return yield t.get().tabs.create({active:!n.pinned,url:n.url,pinned:n.pinned})}))})(e).then((t=>{r(t)})).catch().finally((()=>!0));break;case"@UPDATE_TAB_MESSAGE":(function(e){return T(this,void 0,void 0,(function*(){const{payload:n}=e;if(!n)return;const[o]=yield t.get().tabs.query({active:!0,lastFocusedWindow:!0});return yield t.get().tabs.update(o.id,{url:n.url})}))})(e).then().catch().finally((()=>!0));break;case n:(function(t){return T(this,void 0,void 0,(function*(){const{payload:e}=t;if(!e)return;console.log("Performing fetch for Request: ",e);const n=yield fetch(e.url,e.request);return n.ok?yield n.json():void 0}))})(e).then((t=>{r(t)})).catch((t=>{console.log(t)})).finally((()=>!0));break;case"@CURRENT_TAB_MESSAGE":(function(e){return T(this,void 0,void 0,(function*(){const[e]=yield t.get().tabs.query({active:!0,currentWindow:!0});return e}))})().then((t=>{r(t)})).catch((t=>{console.log(t)})).finally((()=>!0));break;case"@EVENT_LOG_MESSAGE":(function(t){return T(this,void 0,void 0,(function*(){const{payload:e}=t;e&&(yield p.logEvent(e.auth,e.eventName,e.eventProperties))}))})(e).then((t=>{r(t)})).catch((t=>{console.log(t)})).finally((()=>!0));break;case i:(function(){return T(this,void 0,void 0,(function*(){const[e]=yield t.get().tabs.query({active:!0});return yield t.get().tabs.sendMessage(e.id,{id:i,payload:{}})}))})().then((t=>{r(t)})).catch((t=>{console.log(t)})).finally((()=>!0));break;case"@WEB_CASHBACK_ACTIVE":(function(t){return T(this,void 0,void 0,(function*(){const{payload:e}=t;e&&(yield A.set(e.host,e.click_id))}))})(e).then((t=>{r(t)})).catch((t=>{console.log(t)})).finally((()=>!0));break;case o:B(e).then((t=>{r(t)})).catch((t=>{console.log(t)})).finally((()=>!0));break;default:console.log(e)}return!0})),t.get().tabs.onActivated.addListener((t=>{B({id:o,payload:{reset:!0}})})),t.get().tabs.onCreated.addListener((t=>T(void 0,void 0,void 0,(function*(){t.pinned&&(yield h.set(u,t.id.toString()))})))),t.get().tabs.onUpdated.addListener(((e,n)=>T(void 0,void 0,void 0,(function*(){const o=yield h.get(u);e.toString()===o&&n&&"complete"===n.status&&t.get().tabs.remove(e)})))),t.get().alarms.onAlarm.addListener((e=>{e.name===b&&function(){T(this,void 0,void 0,(function*(){const e=t.get().action;if(!e)return;const n=yield h.get(f);n?(e.setBadgeBackgroundColor({color:x.default}),e.setBadgeText({text:"â‚¬"}),e.setBadgeTextColor({color:"#FFFFFF"})):(e.setBadgeBackgroundColor({color:k.default}),e.setBadgeText({text:"â‚¬"}),e.setBadgeTextColor({color:"#FFFFFF"})),yield h.set(f,!n||!n)}))}()}))})();