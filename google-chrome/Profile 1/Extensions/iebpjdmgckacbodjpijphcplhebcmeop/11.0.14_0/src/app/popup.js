"use strict";(()=>{function i8n(key){return chrome.i18n.getMessage(key)}var MajorVersion=11,MinorVersion=14,EXT_PLATFORM="C",CurrentVersion=`${MajorVersion}.0.${MinorVersion}${EXT_PLATFORM}`;var DEV_PRETEND_PRO=!1,DEV_PRETEND_CLOUD=!1;var DEV_DEBUG=!1;var CloudConfigKeys=["gptApiKey","gptTokensConsumed"],ExtractConfigKeys=["addNewLinesForParagraphs","csvDelimiter","deleteEmptyRows","extractImageSrc","getLinkUrls","inlineImagesGSheets","ignoreHiddenPageElements","ignoreHiddenTables","ignoreImages","moneyAsNumber","numberAsNumber","numDecimalChar","numThousandChar","redGreenExtract","removeStrikethroughs"],DurationConfigKeys=["autoScrollInterval","sheetSyncWriteInterval","autoPageWait"],AllConfigKeys=[...ExtractConfigKeys,...CloudConfigKeys,...DurationConfigKeys,"alwaysAllowColumnify","copyImagesToClipboard","enableGDriveWrite","enablePastePrompt","enableRequestSearch","enableUrlAutoPage","filenameTemplate","renderRowPreview","showDeveloperOptions","singleSheetExcelExport","useUnifiedPaging","onboarded","installDate","licenseCode","paidPro","paidCloud","cloudLicenseCode","requiresPaid","googleAuthToken","googleAuthRefreshToken","user","recipes"],DurationDefaultValues={autoScrollInterval:.75*1e3,sheetSyncWriteInterval:10*1e3,autoPageWait:3*1e3},CloudConfigDefaults={gptTokensConsumed:0,gptApiKey:null},UserConfigDefaults={...CloudConfigDefaults,...DurationDefaultValues,addNewLinesForParagraphs:!1,alwaysAllowColumnify:!1,copyImagesToClipboard:!1,csvDelimiter:",",deleteEmptyRows:!0,enableGDriveWrite:!1,enablePastePrompt:!0,enableRequestSearch:!1,enableUrlAutoPage:!1,extractImageSrc:!1,filenameTemplate:"",getLinkUrls:!1,ignoreHiddenPageElements:!0,ignoreHiddenTables:!0,ignoreImages:!1,inlineImagesGSheets:!1,moneyAsNumber:!1,numberAsNumber:!1,numDecimalChar:".",numThousandChar:",",redGreenExtract:!1,removeStrikethroughs:!1,renderRowPreview:!0,showDeveloperOptions:!1,singleSheetExcelExport:!1,useUnifiedPaging:!1,onboarded:!1,installDate:null,licenseCode:null,paidPro:!1,paidCloud:!1,paidProOrMore:!1,cloudLicenseCode:null,requiresPaid:!1,user:null,googleAuthToken:null,googleAuthRefreshToken:null,recipes:[]};var ExtensionId="iebpjdmgckacbodjpijphcplhebcmeop",ExtBase=`chrome-extension://${ExtensionId}`;var NewGoogleSheetsUrl="http://spreadsheets.google.com/ccc?new=true";var AirtableExtension="https://chrome.google.com/webstore/detail/airtable-extractor-by-tab/jdldgiafancpgcleiodepocjobmmfjif",FolkExtension="https://chromewebstore.google.com/detail/folk-extractor-by-table-c/hefnehpofimmddhhjijpfndbnaaoljko",NotionExtension="https://chromewebstore.google.com/detail/notion-data-extractor-by/ncnncaphmnnoijadnoigbeenehkimffp",PowerBiExtension="https://chrome.google.com/webstore/detail/powerbi-extractor-by-tabl/lkojnilkkidnhhdlpkocjfpgfkhholan",DuneExtension="https://chrome.google.com/webstore/detail/dune-data-extractor-by-ta/najiannhbfegmjhgkgikhpdefhnfdbmc",ZillowExtension="https://zillowdataexporter.com/?ref=tcap&source=TableCapture",ReportPageUrl="https://georgemike.com/tables/report?d=$DATA";function buildReportPageUrl(data){let url=ReportPageUrl;return url=url.replace("$DATA",btoa(JSON.stringify(data))),url}var StorageWrapper=class{set(key){throw new Error("StorageWrapper -> set not supported")}get(key){throw new Error("StorageWrapper -> get not supported")}remove(key){throw new Error("StorageWrapper -> remove not supported")}getMaxItems(){return chrome.storage.sync.MAX_ITEMS}getItemByteQuota(){return chrome.storage.sync.QUOTA_BYTES_PER_ITEM}};var ChromeStorageWrapper=class extends StorageWrapper{api_;constructor(api){super(),this.api_=api}removeP(key){return new Promise(resolve=>{this.api_.remove(key,resolve)})}setP(values){return new Promise((resolve,reject)=>{this.api_.set(values,response=>{hasRuntimeError()?reject(getRuntimeError()):resolve(response)})})}getP(keyOrObj){return new Promise(resolve=>{this.api_.get(keyOrObj,resolve)})}},ChromeSyncStorageWrapper=class extends ChromeStorageWrapper{constructor(){super(chrome.storage.sync)}};function hasRuntimeError(){return!!chrome.runtime.lastError}function createTab(params){return new Promise(resolve=>{chrome.tabs.create(params,resolve)})}function isPageOnboardingPage(url){return!!url&&url.startsWith("chrome-extension://")&&url.includes("onboard/onboard.html")}function getRuntimeError(){return chrome.runtime.lastError}function getSyncStorageApi(){return new ChromeSyncStorageWrapper}var BigSyncStorage=class{storageApi_;maxItems_;constructor(storageApi){this.storageApi_=storageApi,this.maxItems_=this.storageApi_.getMaxItems()}getWorlds(defaultVals,worldKeys){return defaultVals=defaultVals||{},worldKeys=worldKeys||[],worldKeys.forEach(worldKey=>defaultVals[worldKey]=""),this.storageApi_.getP(null).then(items=>{if(hasRuntimeError())throw getRuntimeError();let vals={...defaultVals,...items},worlds=[];return worldKeys.forEach(worldKey=>{let world="";for(var i=0;i<this.maxItems_;i++){let key=`${worldKey}_${i}`;if(items[key])world+=items[key];else break}world&&worlds.push(JSON.parse(world))}),worlds.forEach(worldObj=>{vals={...vals,...worldObj}}),{...defaultVals,...vals}})}deleteWorld(worldKey){return this.getWorlds({},[worldKey]).then(vals=>Promise.all(Object.keys(vals).filter(key=>key.includes(worldKey)).map(key=>this.storageApi_.removeP(key))))}setWorld(worldKey,vals){let i=0,cache={},stringVal=JSON.stringify(vals);for(;stringVal.length>0;){let cacheKey=`${worldKey}_${i}`,segment=null,endIndex=this.storageApi_.getItemByteQuota()-cacheKey.length-2;for(;;){if(endIndex<500)return Promise.reject(new Error("BigSyncStorage: World segmentation error (< 500/key)"));segment=stringVal.substr(0,endIndex);let keyLength=16,jsonStringifiedSegment=JSON.stringify(segment);if(lengthInUtf8Bytes(jsonStringifiedSegment)>this.storageApi_.getItemByteQuota()-2-keyLength)endIndex-=500;else break}cache[cacheKey]=segment,stringVal=stringVal.substr(endIndex),i++}return this.storageApi_.setP(cache).then(()=>this.storageApi_.removeP(`${worldKey}_${i}`))}};function lengthInUtf8Bytes(str){var m=encodeURIComponent(str).match(/%[89ABab]/g);return str.length+(m?m.length:0)}function getWorlds(worldKeys,defaultVals){return new BigSyncStorage(getSyncStorageApi()).getWorlds(defaultVals,worldKeys)}function writeBadError(err){console.error(err),document.body.innerHTML=`
    <div class="alert alert-danger" style="margin: 16px;">
      Please close this tab and reopen it before using <strong>Table Capture</strong< on it.
    </div>
  `}function getCurrentExtensionPageUrl(){return typeof window<"u"&&"location"in window&&window.location&&window.location.href?window.location.href:null}function isDunePage(url){return url&&url.includes("https://dune.com/queries")}function isZillowYannPage(url){return url&&(url.includes("https://zillow.com")||url.includes("https://www.zillow.com"))}function isGoogleSheetsAppPage(url){return url&&url.includes("docs.google.com/spreadsheets")&&!url.includes("htmlview")&&!url.includes("/pubhtml?")}function isPowerBiPage(url){return url&&(url.includes("https://powerbi.com/")||url.includes("https://app.powerbi.com/"))}function isNotionPage(url){return url&&(url.includes("notion.so/")||url.includes("notion.site/"))}function isFolkPage(url){return url&&url.includes("app.folk.app/")}function isAirtableAppPage(url){return url&&(url.includes("https://airtable.com/")||url.includes("https://www.airtable.com/"))}function checkSpecialPages(url){let googleSheetsAppPage=!!url&&isGoogleSheetsAppPage(url),zillowPage=!!url&&isZillowYannPage(url),dunePage=!!url&&isDunePage(url),airtablePage=!!url&&isAirtableAppPage(url),notionPage=!!url&&isNotionPage(url),folkPage=!!url&&isFolkPage(url),powerBiPage=!!url&&isPowerBiPage(url);return{googleSheetsAppPage,zillowPage,dunePage,folkPage,notionPage,airtablePage,powerBiPage}}function getExtensionUserConfig(ignorePageUrl=!1){return getWorlds(["_recipe_world"],UserConfigDefaults).then(values=>{Object.keys(values).forEach(key=>{AllConfigKeys.includes(key)||delete values[key]});let config={...values};if(DEV_PRETEND_PRO&&(config.paidPro=!0),DEV_PRETEND_CLOUD&&(config.paidCloud=!0),config.paidProOrMore=!!config.paidPro||!!config.paidCloud,!ignorePageUrl&&!config.paidProOrMore){let pageUrl=getCurrentExtensionPageUrl();pageUrl!==null&&(config.paidPro=isPageOnboardingPage(pageUrl))}return config})}function removeBase64Prefix(base64String){if(!base64String||base64String==="data:")return"";let prefix="base64,",index=base64String.indexOf(prefix);return index===-1?base64String:base64String.substring(index+prefix.length)}function base64ToUint8Array(base64){if(base64=removeBase64Prefix(base64),!base64)return null;let raw=atob(base64),uint8Array=new Uint8Array(new ArrayBuffer(raw.length));for(let i=0;i<raw.length;i++)uint8Array[i]=raw.charCodeAt(i);return uint8Array}function copyImageToClipboard(data){let blob=new Blob([base64ToUint8Array(data)],{type:"image/png"}),item=new ClipboardItem({"image/png":blob});navigator.clipboard.write([item])}function copyToClipboard(data){if(data===null)throw new Error("No data present");function createTextArea(value){let txt=document.createElement("textarea");return txt.className="offscreeneded",txt.value=value,document.body.appendChild(txt),txt}try{let txt=createTextArea(data);txt.select();let success=document.execCommand("copy");if(document.body.removeChild(txt),!success)throw new Error("Copy failed")}catch(err){throw err}}function sendRuntimeMessage(params){return new Promise((resolve,reject)=>{chrome.runtime.sendMessage(params,response=>hasRuntimeError()?reject(getRuntimeError()):response&&response.err?typeof response.err=="string"?reject(new Error(response.err)):reject(response.err):resolve(response))})}var dotRe=/\./,lastDotRe=/\.[^.]*$/,space=" ",lineFeed=`
`,dash="-",dot=".",colon=":",lowercaseC="c",lowercaseL="l",lowercaseR="r",verticalBar="|",minCellSize=3;function markdownTable(table,options={}){var settings=options||{},delimiter=settings.delimiter,start=settings.start,end=settings.end,alignment=settings.align,calculateStringLength=settings.stringLength||lengthNoop,cellCount=0,rowIndex=-1,rowLength=table.length,sizes=[],align,rule,rows,row,cells,index,position,size,value,spacing,before,after;try{table&&table.length&&table.forEach((row2,i)=>{row2.forEach((cell,j)=>{cell.includes("|")&&(table[i][j]=cell.replace(/\|/g,"\\|"))})})}catch{}for(alignment=alignment?alignment.concat():[],delimiter==null&&(delimiter=space+verticalBar+space),start==null&&(start=verticalBar+space),end==null&&(end=space+verticalBar);++rowIndex<rowLength;)for(row=table[rowIndex],index=-1,row.length>cellCount&&(cellCount=row.length);++index<cellCount;)position=row[index]?dotindex(row[index]):null,sizes[index]||(sizes[index]=minCellSize),position>sizes[index]&&(sizes[index]=position);for(typeof alignment=="string"&&(alignment=pad(cellCount,alignment).split("")),index=-1;++index<cellCount;)align=alignment[index],typeof align=="string"&&(align=align.charAt(0).toLowerCase()),align!==lowercaseL&&align!==lowercaseR&&align!==lowercaseC&&align!==dot&&(align=""),alignment[index]=align;for(rowIndex=-1,rows=[];++rowIndex<rowLength;){for(row=table[rowIndex],index=-1,cells=[];++index<cellCount;)value=row[index],value=stringify(value),alignment[index]===dot?(position=dotindex(value),size=sizes[index]+(dotRe.test(value)?0:1)-(calculateStringLength(value)-position),cells[index]=value+pad(size-1)):cells[index]=value;rows[rowIndex]=cells}for(sizes=[],rowIndex=-1;++rowIndex<rowLength;)for(cells=rows[rowIndex],index=-1;++index<cellCount;)value=cells[index],sizes[index]||(sizes[index]=minCellSize),size=calculateStringLength(value),size>sizes[index]&&(sizes[index]=size);for(rowIndex=-1;++rowIndex<rowLength;){if(cells=rows[rowIndex],index=-1,settings.pad!==!1)for(;++index<cellCount;)value=cells[index],position=sizes[index]-(calculateStringLength(value)||0),spacing=pad(position),alignment[index]===lowercaseR||alignment[index]===dot?value=spacing+value:alignment[index]===lowercaseC?(position/=2,position%1===0?(before=position,after=position):(before=position+.5,after=position-.5),value=pad(before)+value+pad(after)):value+=spacing,cells[index]=value;rows[rowIndex]=cells.join(delimiter)}if(settings.rule!==!1){for(index=-1,rule=[];++index<cellCount;)settings.pad===!1?(value=table[0][index],spacing=calculateStringLength(stringify(value)),spacing=spacing>minCellSize?spacing:minCellSize):spacing=sizes[index],align=alignment[index],value=align===lowercaseR||align===""?dash:colon,value+=pad(spacing-2,dash),value+=align!==lowercaseL&&align!==""?colon:dash,rule[index]=value;rows.splice(1,0,rule.join(delimiter))}return start+rows.join(end+lineFeed+start)+end}function stringify(value){return value==null?"":String(value)}function lengthNoop(value){return String(value).length}function pad(length,character=" "){return new Array(length+1).join(character||space)}function dotindex(value){var match=lastDotRe.exec(value);return match?match.index+1:value.length}var TABULAR_COPY_CONST={rowSeparator:`\r
`,colSeparator:"	"};function arrayOfArraysToString(arrayOfArrays,rowSeparator,colSeparator){return arrayOfArrays.map(row=>row.join(colSeparator)).join(rowSeparator)}function postProcessFinalString(str,outputFormat,rowSeparator,colSeparator,extractConfig){if(!str||!str.trim())return str;if(outputFormat=="MARKDOWN"){let asArray=stringToArrayOfArrays(str,rowSeparator,colSeparator);return markdownTable(asArray)}if((outputFormat=="GOOG"||outputFormat=="OFFICE365")&&str.includes('"')){let beginsWithCleaner=new RegExp(/$"/,"g"),rowBeginsWithCleaner=new RegExp(rowSeparator+'"',"g"),colBeginsWithCleaner=new RegExp(colSeparator+'"',"g");str=str.replace(beginsWithCleaner,'""""'),str=str.replace(rowBeginsWithCleaner,`${rowSeparator}""""`),str=str.replace(colBeginsWithCleaner,`${colSeparator}""""`)}if(outputFormat=="GOOG"&&!!extractConfig.inlineImagesGSheets){let imageCellRegex=new RegExp(`(^|${colSeparator})(http.*?)(.png|.jpg|.jpeg|.gif)`,"g");str=str.replace(imageCellRegex,'$1=IMAGE("$2$3", 1)')}return str}function stringToArrayOfArrays(str,rowSeparator,colSeparator){return str?str.split(rowSeparator).map(s=>s.split(colSeparator)):[]}var SurveyUrl="https://goo.gl/forms/0F5PHkDHut8ZYCmo1",AllAds=[{url:"https://presentio.us/?ref=cap-chrome-a2n",legend:i8n("otherAppsFromGeorge"),lead:i8n("tryPresentious"),body:i8n("narratePowerpointsInYourBrow")},{url:"https://presentio.us/?ref=cap-chrome-cc",legend:i8n("otherAppsFromGeorge"),body:i8n("teachersFlipYourClassroomW")},{url:SurveyUrl,legend:i8n("weReDyingForFeedback"),body:i8n("tellUsWhatYouWantUsToAdd")}],AdRenderer=class{getAd(){let randomAdIndex=Math.floor(Math.random()*AllAds.length);return this.getAdTreatment(AllAds[randomAdIndex])}getAdTreatment(config){let wrapper=document.createElement("div");wrapper.className="_tc_footer_ad";let legend=document.createElement("h3");if(legend.textContent=config.legend,config.lead){let adTagline=document.createElement("span");adTagline.textContent=`: ${config.body}`;let adLink=document.createElement("a");adLink.href=config.url,adLink.textContent=config.lead,adLink.addEventListener("click",()=>(createTab({url:config.url}),!1)),wrapper.appendChild(legend),wrapper.appendChild(adLink),wrapper.appendChild(adTagline)}else{let adLink=document.createElement("a");adLink.href=config.url,adLink.textContent=config.body,adLink.addEventListener("click",()=>(createTab({url:config.url}),!1)),wrapper.appendChild(legend),wrapper.appendChild(adLink)}return wrapper}};var SelectionEventKey="sel-event",SelectionAttemptKey="sel-attempt",DataProvider=class{selectionActionCount_=0;selectionAttemptCount_=0;lastResponse_=null;constructor(){this.getSelectionAttemptCount()}getCurrentWindowLocation(){return new Promise(resolve=>{chrome.tabs.query({active:!0,currentWindow:!0},tabs=>{resolve(tabs[0].url??null)})})}triggerRefresh(tabId,hardRefresh,popupInitiated){return this.sendMessageToBackgroundScript({action:"GET_FRAME_INFO",hardRefresh,tabId}).then(r=>{let frameIds=r.frameIds;return this.queryFramesForRefresh_(tabId,frameIds,popupInitiated)})}queryFramesForRefresh_(tabId,frameIds,popupInitiated){return Promise.all(frameIds.map(frameId=>this.sendMessageToActiveTabFrame({action:"REFRESH",popupInitiated,frameId},tabId,frameId,!0))).then(responses=>{let deadFrameIds=responses.filter(r=>r.type==="deadframe").map(response=>response.frameId);this.removeDeadFrames_(tabId,deadFrameIds);let typedResponses=responses.filter(response=>response.type!=="deadframe").map(r=>r),responsesByWindow={};return typedResponses.length!==0&&typedResponses.forEach(response=>{responsesByWindow[response.windowName]?responsesByWindow[response.windowName]={...responsesByWindow[response.windowName],tables:[...responsesByWindow[response.windowName].tables??[],...response.tables??[]]}:responsesByWindow[response.windowName]=response}),responsesByWindow})}getActiveTabId_(providedTabId=null){return providedTabId?Promise.resolve(providedTabId):new Promise((resolve,reject)=>{chrome.tabs.query({active:!0,currentWindow:!0},async tabs=>{if(hasRuntimeError())return reject(getRuntimeError());resolve(tabs[0].id)})})}getTableDefs(responsesByWindow){if(!responsesByWindow)return this.lastResponse_?this.getTableDefs(this.lastResponse_):{tableDefs:[],hasSelectedElement:!1};this.lastResponse_=responsesByWindow;let hasSelectedElement=!1,tableDefs=[];return Object.values(responsesByWindow).forEach(response=>{hasSelectedElement=hasSelectedElement||response.hasSelectedElement,(response.tables??[]).forEach((tableDef,i)=>{let tabldeDefListItem={...tableDef,displayIndex:tableDefs.length};tableDefs.push(tabldeDefListItem)})}),{tableDefs,hasSelectedElement}}sendMessageToActiveTab(params,providedTabId=null){return new Promise((resolve,reject)=>{this.getActiveTabId_(providedTabId).then(tabId=>{chrome.tabs.sendMessage(tabId,params,response=>{if(hasRuntimeError())return reject(getRuntimeError());if(response&&response.err)return reject(new Error(response.err));resolve(response)})})})}sendMessageToBackgroundScript(params){return new Promise((resolve,reject)=>{chrome.runtime.sendMessage(params,response=>{if(hasRuntimeError())return reject(getRuntimeError());if(response&&response.err)return reject(new Error(response.err));resolve(response)})})}sendMessageToActiveTabFrame(params,providedTabId,frameId,ignoreDeadFrames=!1){return new Promise((resolve,reject)=>{this.getActiveTabId_(providedTabId).then(tabId=>{chrome.tabs.sendMessage(tabId,params,{frameId},response=>{if(hasRuntimeError())return ignoreDeadFrames?resolve({type:"deadframe",frameId}):reject(getRuntimeError());if(response&&response.err)return reject(new Error(response.err));resolve(response)})})})}removeDeadFrames_(tabId,deadFrameIds){this.sendMessageToBackgroundScript({action:"REMOVE_DEAD_FRAMES",tabId,frameIds:deadFrameIds})}hasAttemptedSelection(){return this.selectionAttemptCount_>0}incrementSelectionActionCount(){this.selectionActionCount_++,getSyncStorageApi().setP({[SelectionEventKey]:this.selectionActionCount_})}incrementSelectionAttemptCount(){this.selectionAttemptCount_++,getSyncStorageApi().setP({[SelectionAttemptKey]:this.selectionAttemptCount_})}getSelectionActionCount(){return getSyncStorageApi().getP({[SelectionEventKey]:0}).then(values=>(this.selectionActionCount_=values[SelectionEventKey],Promise.resolve(this.selectionActionCount_)))}getSelectionAttemptCount(){return getSyncStorageApi().getP({[SelectionAttemptKey]:0}).then(values=>(this.selectionAttemptCount_=values[SelectionAttemptKey],Promise.resolve(this.selectionAttemptCount_)))}};function stopEventPropagation(e){try{e.stopPropagation(),e.preventDefault()}catch{}return!1}function getTableIdentification(tableDefListItem){return{id:tableDefListItem.id,index:tableDefListItem.index,windowName:tableDefListItem.windowName}}var TableShow=class{refreshCount_=0;wrapper_;actions_;userConfig_;lockedDown_;selectedTables_={};lastSelectionIndex_=null;tooltipTimeout_=null;clearTooltipTimeout_=null;cbs_={};api_;constructor(wrapper,actions,userConfig){this.wrapper_=wrapper,this.actions_=actions,this.userConfig_=userConfig,this.api_=new DataProvider,this.lockedDown_=this.userConfig_.requiresPaid&&!this.userConfig_.paidProOrMore,this.cbs_={copy:this.copyTable.bind(this),goog:this.googTable.bind(this),csv:this.csvTable.bind(this),excel:this.excelTable.bind(this),screenshot:this.screenshot.bind(this),workshop:this.openWorkshopForTable_.bind(this)}}async displayWithError_(activeTab,message){this.display_(activeTab,null),this.displayDismissableError_(message)}async display_(activeTab,responsesByWindow){let currentUrl=activeTab?.url??null,allResponses=Object.values(responsesByWindow??{}),response=allResponses.length>0?allResponses[0]:null;try{if(this.wrapper_.innerHTML="",this.lockedDown_)return this.displayLockedDownPage_();let pdfPage=!!response?.isPdf,xmlPage=!!response?.isXml,{airtablePage,dunePage,folkPage,googleSheetsAppPage,notionPage,powerBiPage,zillowPage}=checkSpecialPages(currentUrl),{hasSelectedElement,tableDefs}=this.api_.getTableDefs(responsesByWindow),specialCaseTable=airtablePage||googleSheetsAppPage||notionPage||folkPage||pdfPage||powerBiPage||xmlPage;if(hasSelectedElement&&!specialCaseTable)return this.openWorkshop_(!0);specialCaseTable?airtablePage?(this.wrapper_.appendChild(this.displayAirTable()),this.wrapper_.appendChild(this.displayLinkFooter("air"))):pdfPage?this.wrapper_.appendChild(this.displayPdf()):googleSheetsAppPage?(this.wrapper_.appendChild(this.displayGoogleSheets(currentUrl)),this.wrapper_.appendChild(this.displayLinkFooter())):powerBiPage?(this.wrapper_.appendChild(this.displayPowerBi()),this.wrapper_.appendChild(this.displayLinkFooter("pbi"))):xmlPage?this.wrapper_.appendChild(this.displayXmlWarning()):folkPage?(this.wrapper_.appendChild(this.displayFolk()),this.wrapper_.appendChild(this.displayLinkFooter("folllk"))):notionPage&&(this.wrapper_.appendChild(this.displayNotion()),this.wrapper_.appendChild(this.displayLinkFooter("noti"))):(zillowPage?this.wrapper_.appendChild(this.displayZillowCTA()):dunePage&&this.wrapper_.appendChild(this.displayDuneCTA()),this.wrapper_.appendChild(this.displayHeader(tableDefs.length)),tableDefs.length===0?(this.wrapper_.appendChild(this.displayAlertWell(chrome.i18n.getMessage("noTablesFound"))),this.wrapper_.appendChild(this.displayNoTablesHelp(currentUrl))):(this.wrapper_.appendChild(this.displayTableList(tableDefs)),this.userConfig_.renderRowPreview&&this.wrapper_.appendChild(this.getPreviewWrapper())),this.userConfig_.paidProOrMore||this.wrapper_.appendChild(new AdRenderer().getAd())),Array.from(this.wrapper_.querySelectorAll(".btn-report-page")).forEach(el=>el.addEventListener("click",this.handlePageReport_.bind(this,currentUrl??"")))}catch(err){writeBadError(err)}}displayLockedDownPage_(){let div=document.createElement("div");div.className="explainer requires-activation",div.innerHTML=`
      <p>${i8n("pleaseActivateSpanClassTc")}</p>
      <a class="b-action" id="upgrade_action">${i8n("activateAction")}</a>
    `,div.querySelector("#upgrade_action").addEventListener("click",this.openUpgradePage_.bind(this,"topbar")),this.wrapper_.appendChild(div)}getPreviewWrapper(){let el=document.createElement("div");return el.id="row-preview-wrapper",el.innerHTML=`
      <h3>${i8n("preview")}</h3>
      <pre>



</pre>
    `,el}displayPowerBi(){let div=document.createElement("div");return div.className="no-tables powerbi-no-tables",div.innerHTML=i8n("powerBiExplainer"),div.querySelector("a").setAttribute("href",PowerBiExtension),div}displayDuneCTA(){let div=document.createElement("div");return div.className="explainer no-tables dune-better",div.innerHTML=i8n("duneExplainer"),div.querySelector("a").setAttribute("href",DuneExtension),div}displayZillowCTA(){let div=document.createElement("div");return div.className="explainer no-tables zillow-better",div.innerHTML=i8n("zillowExplainer"),div.querySelector("a").setAttribute("href",ZillowExtension),div}displayXmlWarning(){let div=document.createElement("div");return div.className="explainer no-tables xml-no-tables",div.innerHTML=`
      <p class="explainer-heading">The current page is an XML document.</p>
      <p>
        Unfortunately, right now <span class="_tc-ext">Table Capture</span> is not able to
        extract tables from XML.
      </p>
    `,div}displayLinkFooter(className=""){let{optionsAction,supportAction}=this.createNavActionButtons();optionsAction.className="btn btn-warning",supportAction.className="btn btn-warning";let div=document.createElement("div");return div.className=`link-footer ${className}`,div.appendChild(optionsAction),div.appendChild(supportAction),div}displayFolk(){let div=document.createElement("div");return div.className="explainer no-tables folk-no-tables",div.innerHTML=i8n("folkExplainer"),div.querySelector("a").setAttribute("href",FolkExtension),div}displayNotion(){let div=document.createElement("div");return div.className="explainer no-tables notion-no-tables",div.innerHTML=i8n("notionExplainer"),div.querySelector("a").setAttribute("href",NotionExtension),div}displayAirTable(){let div=document.createElement("div");return div.className="explainer no-tables airtable-no-tables",div.innerHTML=i8n("airtableExplainer"),div.querySelector("a").setAttribute("href",AirtableExtension),div}displayGoogleSheets(url){url=url.replace(/\/edit.*/,"/htmlview");let div=document.createElement("div");div.className="explainer no-tables sheets-app",div.innerHTML=i8n("googleSheetsExplainer");let anchor=div.querySelector("a");return anchor.setAttribute("href",url),anchor.textContent=url,div}displayPdf(){let div=document.createElement("div");return div.className="explainer no-tables pdf-no-tables",div.innerHTML=i8n("pdfExplainer"),div.querySelector(".btn-launch-pdf").addEventListener("click",async()=>{let currentUrl=await this.api_.getCurrentWindowLocation();createTab({url:`/pdf-extract.html?url=${currentUrl}`})}),div}displayNoTablesHelp(currentUrl){let div=document.createElement("div");return div.className="explainer no-tables",div.innerHTML=i8n("noTablesExplainer"),div.querySelector(".disclaimer span").setAttribute("title",currentUrl||"--"),div}displayAlertWell(text,alertClassName="alert-warning"){let alertWell=document.createElement("div");return alertWell.className=`alert-well alert ${alertClassName}`,alertWell.innerHTML=text,alertWell}displayDismissableError_(message){let well=this.displayAlertWell(message,"alert-danger");well.addEventListener("click",()=>well.remove()),document.querySelector("._tc_error_wrapper").appendChild(well)}displayDismissableUpdate_(message){let well=this.displayAlertWell(message,"alert-success");well.addEventListener("click",()=>well.remove()),document.querySelector("._tc_error_wrapper").appendChild(well)}displayHeader(nTables){let hasTablesPresent=nTables>0,globalErrorWrapper=document.createElement("div");globalErrorWrapper.className="_tc_error_wrapper";let wrapper=document.createElement("div");return wrapper.className="_tc_header",wrapper.appendChild(this.displayHeaderActionWrap()),wrapper.appendChild(this.displayHeaderActionLinkWrap()),wrapper.appendChild(globalErrorWrapper),hasTablesPresent&&Math.random()<.333&&this.displayFeatureTips_(globalErrorWrapper),wrapper.appendChild(this.displayHeaderTitle(nTables)),hasTablesPresent&&wrapper.appendChild(this.displaySelectionHeaderActionWrap()),wrapper}displayFeatureTips_(wrapper){if(this.api_.hasAttemptedSelection())return;let fyiSelectionBanner=document.createElement("div");fyiSelectionBanner.className="alert alert-info",fyiSelectionBanner.innerHTML=i8n("fyiSelectionBanner"),fyiSelectionBanner.addEventListener("click",()=>fyiSelectionBanner.remove()),wrapper.appendChild(fyiSelectionBanner)}displayHeaderTitle(nTables){let header=document.createElement("div");return header.className="_tc_title",header.innerHTML=`
      <span class="main">${chrome.i18n.getMessage("tablesFoundTitle",[nTables+""])}</span>
      <span class="context"></span>
    `,header}updateHeaderTitle(){let{tableDefs}=this.api_.getTableDefs(),nTables=tableDefs.length,nSelected=this.getNumSelectedTables_(),message=nSelected>0?chrome.i18n.getMessage("tablesFoundAndSelectedTitle",[nTables+"",nSelected+""]):chrome.i18n.getMessage("tablesFoundTitle",[nTables+""]);document.querySelector("._tc_title .main").textContent=message,document.querySelector(".selection-bar").classList.toggle("no-selection",nSelected===0),Array.from(document.querySelectorAll(".selection-bar ._tc-right-actions input")).forEach(button=>{button.disabled=nSelected<1})}clearTooltipText(){this.tooltipTimeout_&&(window.clearTimeout(this.tooltipTimeout_),this.tooltipTimeout_=null),this.clearTooltipTimeout_&&window.clearTimeout(this.clearTooltipTimeout_),this.clearTooltipTimeout_=window.setTimeout(()=>{document.querySelector("._tc_title .context").innerHTML="",this.clearTooltipTimeout_=null},100)}displayTooltipText_(text){this.tooltipTimeout_&&window.clearTimeout(this.tooltipTimeout_),this.clearTooltipTimeout_&&(window.clearTimeout(this.clearTooltipTimeout_),this.clearTooltipTimeout_=null),this.tooltipTimeout_=window.setTimeout(()=>{document.querySelector("._tc_title .context").innerHTML=text,this.tooltipTimeout_=null},100)}displaySelectionHeaderActionWrap(){let batchExcelDescription=this.userConfig_.singleSheetExcelExport?chrome.i18n.getMessage("selectedToExcelDescriptionSingleSheet"):chrome.i18n.getMessage("selectedToExcelDescription"),selectionActionWrap=document.createElement("div");return selectionActionWrap.className="selection-bar no-selection",selectionActionWrap.innerHTML=`
      <div class="_tc-left-actions">
        <input type="button"
            class="btn btn-light btn-sm action_select_all"
            title="${chrome.i18n.getMessage("selectAllDescription")}"
            value="${chrome.i18n.getMessage("selectAllAction")}" />
        <input type="button"
            class="btn btn-light btn-sm action_select_none"
            title="${chrome.i18n.getMessage("selectNoneDescription")}"
            value="${chrome.i18n.getMessage("selectNoneAction")}" />
      </div>
      <div class="_tc-right-actions">
        <input type="button"
              class="btn btn-light btn-sm action_copy"
              title="${chrome.i18n.getMessage("copySelectedDescription")}"
              value="${chrome.i18n.getMessage("copySelectedAction")}" />
        <input type="button"
              class="btn btn-light btn-sm action_goog"
              title="${chrome.i18n.getMessage("selectedToGoogleDescription")}"
              value="${chrome.i18n.getMessage("selectedToGoogleAction")}" />
        <input type="button"
              class="btn btn-light btn-sm action_excel"
              title="${batchExcelDescription}"
              value="${chrome.i18n.getMessage("selectedToExcelAction")}" />
      </div>
    `,selectionActionWrap.querySelector(".action_select_all").addEventListener("click",this.selectAllTables.bind(this)),selectionActionWrap.querySelector(".action_select_none").addEventListener("click",this.unselectAllTables.bind(this)),selectionActionWrap.querySelector(".action_copy").addEventListener("click",this.handleCopySelectedTables.bind(this)),selectionActionWrap.querySelector(".action_goog").addEventListener("click",this.selectedToGoogle_.bind(this)),selectionActionWrap.querySelector(".action_excel").addEventListener("click",this.selectedToExcel_.bind(this)),selectionActionWrap}createNavActionButtons(){let optionsAction=document.createElement("a");optionsAction.innerText=chrome.i18n.getMessage("optionsAction"),optionsAction.title=chrome.i18n.getMessage("optionsAction"),optionsAction.id="options-action",optionsAction.addEventListener("click",()=>{createTab({url:"/options.html?ref=popup"})});let supportAction=document.createElement("a");return supportAction.title=chrome.i18n.getMessage("supportAction"),supportAction.id="support_action",supportAction.addEventListener("click",_e=>{createTab({url:"/support.html?ref=popup"})}),supportAction.innerHTML=chrome.i18n.getMessage("supportAction"),{optionsAction,supportAction}}displayHeaderActionLinkWrap(){let wrapper=document.createElement("div");wrapper.className="action-link-wrap";let helpAction=document.createElement("a");helpAction.innerText=chrome.i18n.getMessage("helpAction"),helpAction.className="btn-report-page";let middot=()=>{let el=document.createElement("span");return el.innerHTML="&middot;",el},{optionsAction,supportAction}=this.createNavActionButtons(),favoritesAction=document.createElement("a");return favoritesAction.title=chrome.i18n.getMessage("favoritesAction"),favoritesAction.id="favorites_action",favoritesAction.addEventListener("click",_e=>{createTab({url:"/activity.html?ref=popup"})}),favoritesAction.innerHTML=chrome.i18n.getMessage("favoritesAction"),wrapper.appendChild(optionsAction),wrapper.appendChild(middot()),wrapper.appendChild(supportAction),wrapper.appendChild(middot()),wrapper.appendChild(favoritesAction),wrapper.appendChild(middot()),wrapper.appendChild(helpAction),wrapper}displayHeaderActionWrap(){let actionWrap=document.createElement("div");actionWrap.className="action_wrap";let refreshAction=document.createElement("a");refreshAction.title=i8n("refreshDescription"),refreshAction.className="b-action",refreshAction.id="refresh_action",refreshAction.addEventListener("click",this.refresh.bind(this)),refreshAction.innerHTML=i8n("refreshAction");let workshopAction=document.createElement("a");if(workshopAction.title=i8n("workshopDescription"),workshopAction.className="b-action",workshopAction.id="workshop_action",workshopAction.addEventListener("click",this.openWorkshop_.bind(this,!1)),workshopAction.innerHTML=chrome.i18n.getMessage("workshopAction"),!this.userConfig_.paidProOrMore){let upgradeAction=document.createElement("a");upgradeAction.className="b-action",upgradeAction.id="upgrade_action",upgradeAction.addEventListener("click",this.openUpgradePage_.bind(this,"topbar")),upgradeAction.innerHTML=i8n("upgradeAction"),actionWrap.appendChild(upgradeAction)}if(DEV_DEBUG){let debugAction=document.createElement("a");debugAction.className="b-action",debugAction.addEventListener("click",()=>createTab({url:"/debug.html"})),debugAction.innerHTML=i8n("debugAction"),actionWrap.appendChild(debugAction)}return actionWrap.appendChild(refreshAction),actionWrap.appendChild(workshopAction),actionWrap}displayTableList(tableDefs){let list=document.createElement("ol");return list.className="_tc_table_list",tableDefs.forEach((tableDef,i)=>{let li=document.createElement("li");li.id=tableDef.id??"",li.className="table_def_el",li.innerHTML=`
        <div>
          <span class="table_select_action" title="${tableDef.id??""}">
            ${tableDef?.adjusted??""}
            <span class="hidden status"></span>
          </span>
          <span class="row-actions"></span>
        </div>
        <div class="hidden error-status"></div>
      `,li.querySelector(".error-status").addEventListener("click",this.handleClearErrorStatus_.bind(this)),li.addEventListener("click",e=>(this.toggleTableSelection_(tableDef,e.shiftKey,i),stopEventPropagation(e))),li.addEventListener("mouseenter",e=>(this.highlightTable(tableDef),stopEventPropagation(e))),li.addEventListener("mouseleave",e=>(this.unhighlightTable(tableDef),stopEventPropagation(e)));let rowActionWrapper=li.querySelector(".row-actions");this.actions_.forEach(action=>{let imgURL=chrome.runtime.getURL("/")+action.icon,el=document.createElement("a");el.className=`action action_${action.key} icon icon-disabled-${action.disabled}`,el.innerHTML=`<img alt="${action.key}" src="${imgURL}" />`,el.addEventListener("click",e=>(action.disabled?this.handleDisabledAction_(action.key):this.cbs_[action.key](tableDef),stopEventPropagation(e))),el.addEventListener("mouseenter",this.displayTooltipText_.bind(this,action.tooltip)),el.addEventListener("mouseleave",this.clearTooltipText.bind(this)),rowActionWrapper.appendChild(el)}),list.appendChild(li)}),list.appendChild(this.displayTableListMissingElement_()),list}displayTableListMissingElement_(){let li=document.createElement("li");return li.className="table-not-found",li.innerHTML=i8n("selectInPageBanner"),li.querySelector(".btn").addEventListener("click",this.handleTableNotFound_.bind(this)),li}displayLoader_(){let img=document.createElement("img");img.src=chrome.runtime.getURL("/")+"src/assets/loader.gif",img.className="loading-gif",this.wrapper_.appendChild(img)}async refresh(e){this.selectedTables_={},this.wrapper_.innerHTML="",this.displayLoader_();let tabs=await chrome.tabs.query({active:!0,currentWindow:!0});if(hasRuntimeError())return this.displayWithError_(null,i8n("thereWasAnErrorCommunicating"));let tab=tabs&&tabs.length?tabs[0]:null;return tab?this.refreshWithTab_(tab,!!e?.shiftKey):this.displayWithError_(null,i8n("thereWasAnErrorCommunicating"))}refreshWithTab_(tab,hardRefresh=!1){return tab.id?(this.refreshCount_++,this.api_.triggerRefresh(tab.id,hardRefresh||this.refreshCount_>2,!0).then(r=>this.display_(tab,r)).catch(err=>this.displayWithError_(tab,err.message))):this.displayWithError_(null,i8n("noTabIdFound"))}csvTable(tableDefListItem){this.actionOnTableWrapper_(tableDefListItem,"CSV")}excelTable(tableDefListItem){this.actionOnTableWrapper_(tableDefListItem,"EXCEL")}actionOnTableWrapper_(tableDefListItem,action){let frameId=tableDefListItem.frameId??0,params={action,tableIdentification:getTableIdentification(tableDefListItem)};this.api_.sendMessageToActiveTabFrame(params,null,frameId).catch(err=>this.setTableLinkErrorMessageText(tableDefListItem,err.message))}screenshotToClipboard(tableDefListItem){let frameId=tableDefListItem.frameId??0,params={action:"COPY_TABLE_IMAGE",tableIdentification:getTableIdentification(tableDefListItem)};this.setTableLinkMessageText(tableDefListItem,i8n("loading")),this.api_.sendMessageToActiveTabFrame(params,null,frameId).then(response=>{copyImageToClipboard(response.dataUrl),this.setTableLinkMessageText(tableDefListItem,i8n("copied"))}).catch(err=>this.setTableLinkErrorMessageText(tableDefListItem,err.message))}screenshot(tableDefListItem){if(this.userConfig_.copyImagesToClipboard)return this.screenshotToClipboard(tableDefListItem);let frameId=tableDefListItem.frameId??0,params={action:"SCREENSHOT",tableIdentification:getTableIdentification(tableDefListItem)};this.setTableLinkMessageText(tableDefListItem,i8n("loading")),this.api_.sendMessageToActiveTabFrame(params,null,frameId).catch(err=>this.setTableLinkErrorMessageText(tableDefListItem,err.message)).finally(()=>this.clearTableLinkMessage(tableDefListItem))}copyTable(tableDefListItem,outputFormat){outputFormat=outputFormat||"CLIPBOARD";let frameId=tableDefListItem.frameId||0,params={outputFormat,action:"COPY",tableIdentification:getTableIdentification(tableDefListItem)};return this.setTableLinkMessage(tableDefListItem,!0,!1),this.api_.sendMessageToActiveTabFrame(params,null,frameId).then(()=>(this.setTableLinkMessage(tableDefListItem,!1,!0),Promise.resolve())).catch(err=>(this.setTableLinkMessage(tableDefListItem,!1,!1,err.message),Promise.reject(err)))}googTable(tableDefListItem){return this.copyTable(tableDefListItem,"GOOG").then(()=>this.googDocCreate_())}googDocCreate_(){let params={url:NewGoogleSheetsUrl,enablePastePrompt:this.userConfig_.enablePastePrompt,outputFormat:"GOOG"};return sendRuntimeMessage(params)}openUpgradePage_(ref){createTab({url:`/upgrade.html?ref=${ref}`})}handleClearErrorStatus_(e){if(e.target){let errorStatus=e.target;errorStatus.classList.contains("error-status")||(errorStatus=errorStatus.closest(".error-status")),errorStatus.querySelector("div")?.remove(),errorStatus.classList.add("hidden")}return stopEventPropagation(e)}clearTableLinkMessage(tableDefListItem){this.setTableLinkMessageText(tableDefListItem,"")}setTableLinkErrorMessageText(tableDefListItem,text){let errorStatusEl=Array.from(document.querySelectorAll("ol._tc_table_list li .error-status"))[tableDefListItem.displayIndex];errorStatusEl.innerHTML=`<div>${text}</div>`,errorStatusEl.classList.remove("hidden")}setTableLinkMessageText(tableDefListItem,text){let el=document.querySelectorAll("ol._tc_table_list li .status")[tableDefListItem.displayIndex];el.innerHTML=`&middot;&nbsp;${text}`,el.classList.remove("hidden")}setTableLinkMessage(tableDefListItem,copying,copied,errorMessage=null){let message="";errorMessage?message=errorMessage:copying?message=i8n("copying"):copied&&(message=i8n("copyComplete")),this.setTableLinkMessageText(tableDefListItem,message)}highlightTable(tableDefListItem){let frameId=tableDefListItem.frameId??0,params={action:"HIGHLIGHT",renderRowPreview:this.userConfig_.renderRowPreview,tableIdentification:getTableIdentification(tableDefListItem)};this.api_.sendMessageToActiveTabFrame(params,null,frameId).then(response=>{this.userConfig_.renderRowPreview&&response&&this.renderTablePreview(response.preview)})}unhighlightTable(tableDefListItem){let frameId=tableDefListItem.frameId??0,params={action:"UNHIGHLIGHT",tableIdentification:getTableIdentification(tableDefListItem)};this.api_.sendMessageToActiveTabFrame(params,null,frameId).then(()=>this.clearTablePreview())}renderTablePreview(preview){if(!preview)return;let summary=null;preview.length===0?summary=i8n("noPreviewableData")+`


`:preview.length===1?summary=`${i8n("firstAndOnlyRow")} ${preview[0].join(",")}


`:summary=`${i8n("headers")} ${preview[0].join(",")}
${i8n("firstRow")} ${preview[1].join(",")}
...`,document.querySelector("#row-preview-wrapper pre").textContent=summary}clearTablePreview(){this.userConfig_.renderRowPreview&&(document.querySelector("#row-preview-wrapper pre").textContent=`


`)}setTableSelection(tableDefListItem,select,batchSelect=!1,selectionIndex=null){let listEls=document.querySelectorAll("._tc_table_list li"),canToggle=listEls.length&&listEls.length>tableDefListItem.displayIndex&&listEls[tableDefListItem.displayIndex];if(select===!0&&batchSelect&&this.lastSelectionIndex_!==null&&selectionIndex!==null){let min=Math.min(this.lastSelectionIndex_,selectionIndex),max=Math.max(this.lastSelectionIndex_,selectionIndex);for(let i=min;i<=max;i++){let{tableDefs}=this.api_.getTableDefs();this.setTableSelection(tableDefs[i],!0,!1,i)}this.lastSelectionIndex_=selectionIndex}else select===!0?(this.selectedTables_[tableDefListItem.displayIndex]=tableDefListItem,canToggle&&(listEls[tableDefListItem.displayIndex].classList.add("selected"),this.lastSelectionIndex_=selectionIndex)):select===!1&&(this.selectedTables_[tableDefListItem.displayIndex]=!1,canToggle&&listEls[tableDefListItem.displayIndex].classList.remove("selected"),this.lastSelectionIndex_=null);this.updateHeaderTitle()}toggleTableSelection_(tableDefListItem,batchSelect,index){var selected=!1;this.selectedTables_.hasOwnProperty(tableDefListItem.displayIndex)&&(selected=!!this.selectedTables_[tableDefListItem.displayIndex]),this.setTableSelection(tableDefListItem,!selected,batchSelect,index)}unselectAllTables(){let{tableDefs}=this.api_.getTableDefs();tableDefs.forEach(tableDef=>this.setTableSelection(tableDef,!1)),this.updateHeaderTitle()}selectAllTables(){let{tableDefs}=this.api_.getTableDefs();tableDefs.forEach(tableDef=>this.setTableSelection(tableDef,!0)),this.updateHeaderTitle()}getNumSelectedTables_(){return this.getSelectedTables_().length}getSelectedTables_(){return(Object.values(this.selectedTables_)??[]).filter(tableWrapperMaybe=>!!tableWrapperMaybe).flatMap(t=>t?[t]:[])}handleDisabledAction_(key){let message="";key==="excel"?message=i8n("downloadingTablesInExcelXl"):key==="csv"?message=i8n("downloadingTablesAsACsvFile"):key==="screenshot"?message=i8n("screenshottingTablesIsOnlyAv"):message=i8n("thisFeatureIsOnlyAvailableW"),this.displayDismissableError_(message)}handleCopySelectedTables(){this.shardRollUpExtract_().then(datasets=>this.shardedResponsesToClipboard_(datasets,"CLIPBOARD")).then(()=>this.displayDismissableUpdate_(i8n("selectedTablesCopied"))).catch(err=>{this.displayDismissableError_(err.message)})}selectedToExcel_(){this.userConfig_.paidProOrMore?this.shardRollUpExtract_().then(datasets=>this.shardedResponsesToExcel_(datasets)).catch(err=>this.displayDismissableError_(err.message)):this.handleDisabledAction_("excel")}shardedResponsesToClipboard_(datasets,outputFormat){if(datasets.length===0)return Promise.reject(new Error(i8n("noDatasetsPresent")));let arrayOfArrays=[];datasets.forEach(dataset=>{dataset.forEach(row=>{arrayOfArrays.push(row)}),arrayOfArrays.push([])});let str=arrayOfArraysToString(arrayOfArrays,TABULAR_COPY_CONST.rowSeparator,TABULAR_COPY_CONST.colSeparator),stringData=postProcessFinalString(str,outputFormat,TABULAR_COPY_CONST.rowSeparator,TABULAR_COPY_CONST.colSeparator,{});return copyToClipboard(stringData),this.unselectAllTables(),Promise.resolve()}shardedResponsesToExcel_(datasets){if(datasets.length===0)return Promise.reject(new Error(i8n("noDatasetsPresent")));let params={action:"DATA_TO_EXCEL",datasets,swallowEarlyQuit:!0,windowName:this.getAnyWindowName_(),filenameTemplate:this.userConfig_.filenameTemplate,singleSheetExcelExport:this.userConfig_.singleSheetExcelExport,userConfig:this.userConfig_};return this.api_.sendMessageToActiveTab(params)}selectedToGoogle_(){this.shardRollUpExtract_().then(datasets=>this.shardedResponsesToClipboard_(datasets,"GOOG")).then(()=>this.googDocCreate_()).catch(err=>this.displayDismissableError_(err.message))}shardRollUpExtract_(){let tableWrapperCount=this.getNumSelectedTables_(),wrappersByWindow=this.getSelectedWrappersByWindow_();return Promise.all(Object.keys(wrappersByWindow).map(windowName=>{let tableWrappers=wrappersByWindow[windowName];return this.getSelectedWindowTablesData_(windowName,tableWrappers)})).then(responses=>{let allDatasets=[];if(responses.forEach(response=>{response.datasets&&(allDatasets=[...allDatasets,...response.datasets])}),allDatasets.length<tableWrapperCount)throw new Error(chrome.i18n.getMessage("notAllTablesExtracted",[tableWrapperCount+"",allDatasets.length+""]));return allDatasets})}getSelectedWindowTablesData_(windowName,windowTableWrappers){let params={action:"GET_DATA_BATCH",swallowEarlyQuit:!0,windowName,indexes:windowTableWrappers.map(wrapper=>wrapper.index)};return this.api_.sendMessageToActiveTab(params).then(response=>response)}getAnyWindowName_(){let wrappersByWindow=this.getSelectedWrappersByWindow_(),windowKeys=Object.keys(wrappersByWindow);if(windowKeys&&windowKeys.length)return windowKeys[0];throw new Error(i8n("unableToGetAnyWindowByName"))}getSelectedWrappersByWindow_(){let wrappersByWindow={};return this.getSelectedTables_().forEach(tableDef=>{let windowName=tableDef.windowName;if(!windowName)throw new Error(i8n("noWindowNameFoundForTable"));wrappersByWindow[windowName]||(wrappersByWindow[windowName]=[]),wrappersByWindow[windowName].push(tableDef)}),wrappersByWindow}handlePageReport_(currentPageUrl){let data={url:currentPageUrl,pro:this.userConfig_.paidProOrMore,licenseCode:this.userConfig_.licenseCode||this.userConfig_.cloudLicenseCode};createTab({url:buildReportPageUrl(data)})}handleTableNotFound_(){this.openWorkshop_(!1)}openWorkshop_(hasSelection){hasSelection&&this.api_.incrementSelectionAttemptCount();let params={action:"SELECTION_WORKSHOP",userConfig:this.userConfig_,hasSelection,forTable:!1};return this.api_.sendMessageToActiveTab(params).then(()=>window.close()).catch(err=>{this.displayDismissableError_(err.message)})}openWorkshopForTable_(tableDefListItem){this.api_.incrementSelectionAttemptCount();let forRecipe="recipe"in tableDefListItem&&!!tableDefListItem.recipe,params={action:forRecipe?"SELECTION_WORKSHOP_RECIPE":"SELECTION_WORKSHOP",userConfig:this.userConfig_,hasSelection:!1,forTable:!0,tableIdentification:getTableIdentification(tableDefListItem)};if(forRecipe){let recipeTableDefListItem=tableDefListItem;params.recipe=recipeTableDefListItem.recipe}let frameId=tableDefListItem.frameId??0;return this.api_.sendMessageToActiveTabFrame(params,null,frameId).then(()=>window.close()).catch(err=>this.setTableLinkErrorMessageText(tableDefListItem,err.message))}};function initializePopup(userConfig){let actions=[{key:"workshop",tooltip:i8n("openWorkshopAction"),icon:"src/assets/icon.menu.png",disabled:!1},{key:"goog",tooltip:i8n("googleDocActionTooltip"),icon:"src/assets/icon.sheets.png",disabled:!1},{key:"copy",tooltip:i8n("copyClipboardActionTooltip"),icon:"src/assets/icon.clipboard.add.png",disabled:!1},{key:"screenshot",tooltip:i8n("screenshotActionTooltip"),icon:"src/assets/icon.screenshot.png",disabled:!userConfig.paidPro},{key:"csv",tooltip:i8n("csvActionTooltip"),icon:"src/assets/icon.csv.b.png",disabled:!userConfig.paidPro},{key:"excel",tooltip:i8n("excelActionTooltip"),icon:"src/assets/icon.excel.svg",disabled:!userConfig.paidPro}];try{new TableShow(document.body,actions,userConfig).refresh(null)}catch(err){writeBadError(err)}}try{window.addEventListener("DOMContentLoaded",()=>{getExtensionUserConfig().then(userConfig=>initializePopup(userConfig)).catch(err=>writeBadError(err))})}catch(error){console.log(error)}})();
